/******/ (() => { // webpackBootstrap
/******/ 	"use strict";
/*!**********************!*\
  !*** ./src/index.ts ***!
  \**********************/

// Copyright (c) Microsoft Corporation.
// Licensed under the MIT License.
class WhisperRecognizer {
    constructor() {
        this.audioContext = null;
        this.mediaStreamSource = null;
        this.analyser = null;
        this.mediaRecorder = null;
        this.silenceTimeout = null;
        this.awaitingResult = false;
        this.audioChunks = [];
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
            this.audioContext = new AudioContext();
            this.mediaStreamSource =
                this.audioContext.createMediaStreamSource(stream);
            this.analyser = this.audioContext.createAnalyser();
            this.analyser.minDecibels = -100;
            this.mediaStreamSource.connect(this.analyser);
            this.mediaRecorder = new MediaRecorder(stream);
            this.mediaRecorder.ondataavailable = async (e) => {
                this.audioChunks.push(e.data);
                if (this.mediaRecorder.state === "inactive" ||
                    !this.awaitingResult) {
                    const blob = new Blob(this.audioChunks, {
                        type: "audio/mpeg-3",
                    });
                    const text = await this.getTranscription(blob);
                    if (this.mediaRecorder.state === "inactive") {
                        if (this.recognizedCallback) {
                            this.recognizedCallback({ text });
                        }
                    }
                    else {
                        if (this.recognizingCallback) {
                            this.recognizingCallback({ text });
                        }
                    }
                }
            };
        });
    }
    startRecording() {
        this.audioChunks = [];
        this.mediaRecorder?.start(200);
        this.checkForSilence();
    }
    stopRecording() {
        this.mediaRecorder?.stop();
    }
    onRecognizing(callback) {
        this.recognizingCallback = callback;
    }
    onRecognized(callback) {
        this.recognizedCallback = callback;
    }
    async getTranscription(blob) {
        this.awaitingResult = true;
        const formData = new FormData();
        formData.append("file", blob);
        const response = await fetch("http://localhost:8001/transcribe", {
            method: "POST",
            body: formData,
        });
        let responseBody = await response.json();
        this.awaitingResult = false;
        return responseBody.transcription;
    }
    checkForSilence() {
        const bufferLength = this.analyser.fftSize;
        const amplitudeArray = new Float32Array(bufferLength || 0);
        const silenceDuration = 1000;
        const silenceThreshold = -50;
        this.analyser.getFloatTimeDomainData(amplitudeArray);
        const volume = this.getVolume(amplitudeArray);
        if (volume < silenceThreshold) {
            if (!this.silenceTimeout &&
                this.mediaRecorder.state !== "inactive") {
                this.silenceTimeout = setTimeout(() => {
                    this.mediaRecorder?.stop();
                    this.silenceTimeout = null;
                }, silenceDuration);
            }
        }
        else {
            if (this.silenceTimeout) {
                clearTimeout(this.silenceTimeout);
                this.silenceTimeout = null;
            }
        }
        requestAnimationFrame(() => this.checkForSilence());
    }
    getVolume(amplitudeArray) {
        const values = amplitudeArray.reduce((sum, value) => sum + value * value, 0);
        const average = Math.sqrt(values / amplitudeArray.length);
        const volume = 20 * Math.log10(average);
        return volume;
    }
}

/******/ })()
;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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QUFFLENBQUM7b0JBQzNCLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO2dCQUMvQixDQUFDLEVBQUUsZUFBZSxDQUFDLENBQUM7WUFDeEIsQ0FBQztRQUNMLENBQUM7YUFBTSxDQUFDO1lBQ0osSUFBSSxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQ3RCLFlBQVksQ0FBQyxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7Z0JBQ2xDLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO1lBQy9CLENBQUM7UUFDTCxDQUFDO1FBRUQscUJBQXFCLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVPLFNBQVMsQ0FBQyxjQUE0QjtRQUMxQyxNQUFNLE1BQU0sR0FBRyxjQUFjLENBQUMsTUFBTSxDQUNoQyxDQUFDLEdBQUcsRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxLQUFLLEdBQUcsS0FBSyxFQUNuQyxDQUFDLENBQ0osQ0FBQztRQUNGLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMxRCxNQUFNLE1BQU0sR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUN4QyxPQUFPLE1BQU0sQ0FBQztJQUNsQixDQUFDO0NBQ0oiLCJzb3VyY2VzIjpbIndlYnBhY2s6Ly9sb2NhbC13aGlzcGVyLWNsaWVudC8uL3NyYy9pbmRleC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgKGMpIE1pY3Jvc29mdCBDb3Jwb3JhdGlvbi5cbi8vIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS5cblxuY2xhc3MgV2hpc3BlclJlY29nbml6ZXIge1xuICAgIHByaXZhdGUgYXVkaW9Db250ZXh0OiBBdWRpb0NvbnRleHQgfCBudWxsID0gbnVsbDtcbiAgICBwcml2YXRlIG1lZGlhU3RyZWFtU291cmNlOiBNZWRpYVN0cmVhbUF1ZGlvU291cmNlTm9kZSB8IG51bGwgPSBudWxsO1xuICAgIHByaXZhdGUgYW5hbHlzZXI6IEFuYWx5c2VyTm9kZSB8IG51bGwgPSBudWxsO1xuICAgIHByaXZhdGUgbWVkaWFSZWNvcmRlcjogTWVkaWFSZWNvcmRlciB8IG51bGwgPSBudWxsO1xuICAgIHByaXZhdGUgc2lsZW5jZVRpbWVvdXQ6IGFueSA9IG51bGw7XG4gICAgcHJpdmF0ZSBhd2FpdGluZ1Jlc3VsdCA9IGZhbHNlO1xuICAgIHByaXZhdGUgcmVjb2duaXppbmdDYWxsYmFjazpcbiAgICAgICAgfCAoKHJlc3VsdDogeyB0ZXh0OiBzdHJpbmcgfSkgPT4gdm9pZClcbiAgICAgICAgfCB1bmRlZmluZWQ7XG4gICAgcHJpdmF0ZSByZWNvZ25pemVkQ2FsbGJhY2s6XG4gICAgICAgIHwgKChyZXN1bHQ6IHsgdGV4dDogc3RyaW5nIH0pID0+IHZvaWQpXG4gICAgICAgIHwgdW5kZWZpbmVkO1xuICAgIHByaXZhdGUgYXVkaW9DaHVua3M6IEJsb2JbXSA9IFtdO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKHsgYXVkaW86IHRydWUgfSkudGhlbigoc3RyZWFtKSA9PiB7XG4gICAgICAgICAgICB0aGlzLmF1ZGlvQ29udGV4dCA9IG5ldyBBdWRpb0NvbnRleHQoKTtcbiAgICAgICAgICAgIHRoaXMubWVkaWFTdHJlYW1Tb3VyY2UgPVxuICAgICAgICAgICAgICAgIHRoaXMuYXVkaW9Db250ZXh0LmNyZWF0ZU1lZGlhU3RyZWFtU291cmNlKHN0cmVhbSk7XG4gICAgICAgICAgICB0aGlzLmFuYWx5c2VyID0gdGhpcy5hdWRpb0NvbnRleHQuY3JlYXRlQW5hbHlzZXIoKTtcbiAgICAgICAgICAgIHRoaXMuYW5hbHlzZXIubWluRGVjaWJlbHMgPSAtMTAwO1xuICAgICAgICAgICAgdGhpcy5tZWRpYVN0cmVhbVNvdXJjZS5jb25uZWN0KHRoaXMuYW5hbHlzZXIpO1xuXG4gICAgICAgICAgICB0aGlzLm1lZGlhUmVjb3JkZXIgPSBuZXcgTWVkaWFSZWNvcmRlcihzdHJlYW0pO1xuICAgICAgICAgICAgdGhpcy5tZWRpYVJlY29yZGVyLm9uZGF0YWF2YWlsYWJsZSA9IGFzeW5jIChlKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5hdWRpb0NodW5rcy5wdXNoKGUuZGF0YSk7XG5cbiAgICAgICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubWVkaWFSZWNvcmRlciEuc3RhdGUgPT09IFwiaW5hY3RpdmVcIiB8fFxuICAgICAgICAgICAgICAgICAgICAhdGhpcy5hd2FpdGluZ1Jlc3VsdFxuICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBibG9iID0gbmV3IEJsb2IodGhpcy5hdWRpb0NodW5rcywge1xuICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJhdWRpby9tcGVnLTNcIixcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHRleHQgPSBhd2FpdCB0aGlzLmdldFRyYW5zY3JpcHRpb24oYmxvYik7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLm1lZGlhUmVjb3JkZXIhLnN0YXRlID09PSBcImluYWN0aXZlXCIpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlY29nbml6ZWRDYWxsYmFjaykge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucmVjb2duaXplZENhbGxiYWNrKHsgdGV4dCB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLnJlY29nbml6aW5nQ2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnJlY29nbml6aW5nQ2FsbGJhY2soeyB0ZXh0IH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc3RhcnRSZWNvcmRpbmcoKSB7XG4gICAgICAgIHRoaXMuYXVkaW9DaHVua3MgPSBbXTtcbiAgICAgICAgdGhpcy5tZWRpYVJlY29yZGVyPy5zdGFydCgyMDApO1xuICAgICAgICB0aGlzLmNoZWNrRm9yU2lsZW5jZSgpO1xuICAgIH1cblxuICAgIHN0b3BSZWNvcmRpbmcoKSB7XG4gICAgICAgIHRoaXMubWVkaWFSZWNvcmRlcj8uc3RvcCgpO1xuICAgIH1cblxuICAgIG9uUmVjb2duaXppbmcoY2FsbGJhY2s6IChyZXN1bHQ6IHsgdGV4dDogc3RyaW5nIH0pID0+IHZvaWQpIHtcbiAgICAgICAgdGhpcy5yZWNvZ25pemluZ0NhbGxiYWNrID0gY2FsbGJhY2s7XG4gICAgfVxuXG4gICAgb25SZWNvZ25pemVkKGNhbGxiYWNrOiAocmVzdWx0OiB7IHRleHQ6IHN0cmluZyB9KSA9PiB2b2lkKSB7XG4gICAgICAgIHRoaXMucmVjb2duaXplZENhbGxiYWNrID0gY2FsbGJhY2s7XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBhc3luYyBnZXRUcmFuc2NyaXB0aW9uKGJsb2I6IEJsb2IpOiBQcm9taXNlPHN0cmluZz4ge1xuICAgICAgICB0aGlzLmF3YWl0aW5nUmVzdWx0ID0gdHJ1ZTtcbiAgICAgICAgY29uc3QgZm9ybURhdGEgPSBuZXcgRm9ybURhdGEoKTtcbiAgICAgICAgZm9ybURhdGEuYXBwZW5kKFwiZmlsZVwiLCBibG9iKTtcbiAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChcImh0dHA6Ly9sb2NhbGhvc3Q6ODAwMS90cmFuc2NyaWJlXCIsIHtcbiAgICAgICAgICAgIG1ldGhvZDogXCJQT1NUXCIsXG4gICAgICAgICAgICBib2R5OiBmb3JtRGF0YSxcbiAgICAgICAgfSk7XG5cbiAgICAgICAgbGV0IHJlc3BvbnNlQm9keSA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgICAgICAgdGhpcy5hd2FpdGluZ1Jlc3VsdCA9IGZhbHNlO1xuICAgICAgICByZXR1cm4gcmVzcG9uc2VCb2R5LnRyYW5zY3JpcHRpb247XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBjaGVja0ZvclNpbGVuY2UoKSB7XG4gICAgICAgIGNvbnN0IGJ1ZmZlckxlbmd0aCA9IHRoaXMuYW5hbHlzZXIhLmZmdFNpemU7XG4gICAgICAgIGNvbnN0IGFtcGxpdHVkZUFycmF5ID0gbmV3IEZsb2F0MzJBcnJheShidWZmZXJMZW5ndGggfHwgMCk7XG4gICAgICAgIGNvbnN0IHNpbGVuY2VEdXJhdGlvbiA9IDEwMDA7XG4gICAgICAgIGNvbnN0IHNpbGVuY2VUaHJlc2hvbGQgPSAtNTA7XG5cbiAgICAgICAgdGhpcy5hbmFseXNlciEuZ2V0RmxvYXRUaW1lRG9tYWluRGF0YShhbXBsaXR1ZGVBcnJheSk7XG5cbiAgICAgICAgY29uc3Qgdm9sdW1lID0gdGhpcy5nZXRWb2x1bWUoYW1wbGl0dWRlQXJyYXkpO1xuXG4gICAgICAgIGlmICh2b2x1bWUgPCBzaWxlbmNlVGhyZXNob2xkKSB7XG4gICAgICAgICAgICBpZiAoXG4gICAgICAgICAgICAgICAgIXRoaXMuc2lsZW5jZVRpbWVvdXQgJiZcbiAgICAgICAgICAgICAgICB0aGlzLm1lZGlhUmVjb3JkZXIhLnN0YXRlICE9PSBcImluYWN0aXZlXCJcbiAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgIHRoaXMuc2lsZW5jZVRpbWVvdXQgPSBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5tZWRpYVJlY29yZGVyPy5zdG9wKCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuc2lsZW5jZVRpbWVvdXQgPSBudWxsO1xuICAgICAgICAgICAgICAgIH0sIHNpbGVuY2VEdXJhdGlvbik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy5zaWxlbmNlVGltZW91dCkge1xuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnNpbGVuY2VUaW1lb3V0KTtcbiAgICAgICAgICAgICAgICB0aGlzLnNpbGVuY2VUaW1lb3V0ID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB0aGlzLmNoZWNrRm9yU2lsZW5jZSgpKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGdldFZvbHVtZShhbXBsaXR1ZGVBcnJheTogRmxvYXQzMkFycmF5KSB7XG4gICAgICAgIGNvbnN0IHZhbHVlcyA9IGFtcGxpdHVkZUFycmF5LnJlZHVjZShcbiAgICAgICAgICAgIChzdW0sIHZhbHVlKSA9PiBzdW0gKyB2YWx1ZSAqIHZhbHVlLFxuICAgICAgICAgICAgMCxcbiAgICAgICAgKTtcbiAgICAgICAgY29uc3QgYXZlcmFnZSA9IE1hdGguc3FydCh2YWx1ZXMgLyBhbXBsaXR1ZGVBcnJheS5sZW5ndGgpO1xuICAgICAgICBjb25zdCB2b2x1bWUgPSAyMCAqIE1hdGgubG9nMTAoYXZlcmFnZSk7XG4gICAgICAgIHJldHVybiB2b2x1bWU7XG4gICAgfVxufVxuIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9